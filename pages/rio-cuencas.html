<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ğŸŒŠ RÃ­os y Cuencas â€” Ã‘uble</title>
  <link rel="stylesheet" href="../assets/css/styles.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
  .side{position:absolute; top:10px; right:10px; background:#0f1419e6; border:1px solid var(--outline); border-radius:12px; padding:10px; color:#cde9ff; z-index:500; min-width:220px}
  .val{font-weight:800} .state{padding:4px 8px; border-radius:999px; margin-left:6px}
  </style>
</head>
<body class="fullscreen">
  <div class="toolbar"><div class="title">ğŸŒŠ RÃ­os y Cuencas</div><div class="controls"><a class="toggle" href="../index.html">â†©ï¸ Volver</a></div></div>
  <div class="mapwrap">
    <div id="map"></div>
    <div class="side"><div>ğŸ’§ Caudal: <span class="val" id="v-caudal">â€”</span></div><div>ğŸ“ Nivel: <span class="val" id="v-nivel">â€”</span></div><div>Estado: <span id="v-estado" class="state">â€”</span></div></div>
  </div>
<script>
const map=L.map('map').setView([-36.7,-72.3],8);
const osm=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'Â© OpenStreetMap'}).addTo(map);

async function loadLayer(url, style, onEach){
  const r=await fetch(url); const gj=await r.json();
  return L.geoJSON(gj,{style:style, onEachFeature:onEach}).addTo(map);
}
function styleCuencas(){ return {color:'#3fd37a', weight:2, fillOpacity:0.08}; }
function onEach(f,l){ if(f.properties && f.properties.name){ l.bindPopup("<b>"+f.properties.name+"</b>"); } }
loadLayer('../data/cuencas_itata_nuble.geojson', styleCuencas(), onEach);

fetch('../data/estaciones_caudal.geojson').then(r=>r.json()).then(gj=>{
  L.geoJSON(gj,{
    pointToLayer:(f,latlng)=> L.circleMarker(latlng,{radius:6, color:'#5bd6ff', fillColor:'#5bd6ff', fillOpacity:.9, weight:2}),
    onEachFeature:(f,l)=> l.bindPopup("<b>"+f.properties.estacion+"</b><br>"+f.properties.param)
  }).addTo(map);
});

function rnd(min,max){return Math.round((min + Math.random()*(max-min))*10)/10;}
function upd(){
  const c=rnd(5,80), n=rnd(0.2,3.6);
  const est=(c>60 || n>3)?'rojo':(c>30?'amarillo':'verde');
  document.getElementById('v-caudal').textContent=c+' m3/s';
  document.getElementById('v-nivel').textContent=n+' m';
  const el=document.getElementById('v-estado'); el.textContent=est.toUpperCase();
  el.style.background= est==='rojo' ? '#ff6b6b' : (est==='amarillo' ? '#ffd166' : '#3fd37a'); el.style.color='#0b0f12';
}
upd(); setInterval(upd,5000);
</script>
</body></html>
