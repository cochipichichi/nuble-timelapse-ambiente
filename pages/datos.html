<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
  <title>📈 Datos — Caudales & Series</title>
  <link rel="stylesheet" href="../assets/css/styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body>
  <div class="header">
    <div class="logo">📈 Datos — Caudales</div>
    <div class="controls"><a class="toggle" href="../index.html">↩️ Volver</a><button class="toggle" data-toggle="hc">🌓 Alto contraste</button></div>
  </div>
  <main class="hero">
    <h1>Sube tu CSV</h1>
    <p>Formato: fecha, serie1, serie2, ... (YYYY-MM-DD).</p>
    <input type="file" id="file" accept=".csv">
    <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap">
      <button class="btn" id="savepng">📥 Guardar gráfico (.png)</button>
      <button class="btn ok" id="savepdf">📄 Generar reporte (.pdf)</button>
    </div>
    <canvas id="chart" height="120" style="margin-top:14px"></canvas>
  </main>
  <section class="grid">
    <article class="card"><h3>Ejemplo rápido</h3><p>Descarga un CSV de ejemplo para probar.</p><a class="btn" href="../data/ejemplo_caudal.csv" download>⬇️ Descargar ejemplo</a></article>
  </section>
  <footer class="footer"><p>Proyecto Ñuble — Observatorio Ambiental Interactivo</p></footer>
  <script src="../assets/js/shared.js"></script>
  <script src="../assets/js/logros.js"></script>
  <script>
  function parseCSV(t){const lines=t.trim().split(/\\r?\\n/), headers=lines[0].split(',').map(h=>h.trim()), rows=lines.slice(1).map(l=>l.split(',').map(x=>x.trim())); return {headers,rows};}
  const fileInput=document.getElementById('file'); const ctx=document.getElementById('chart'); let chart;
  fileInput.addEventListener('change', async ()=>{
    const file=fileInput.files[0]; if(!file) return; const text=await file.text(); const {headers,rows}=parseCSV(text);
    const labels=rows.map(r=>r[0]);
    const series=headers.slice(1).map((h,idx)=>({label:h,data:rows.map(r=>Number(r[idx+1]||0)),borderWidth:2,tension:.2}));
    if(chart) chart.destroy(); chart=new Chart(ctx,{type:'line', data:{labels,datasets:series}, options:{responsive:true,plugins:{legend:{position:'bottom'}}}});
  });
  document.getElementById('savepng').onclick=()=>{ if(!chart) return; const a=document.createElement('a'); a.href=chart.toBase64Image(); a.download='grafico_caudales.png'; a.click(); };
  document.getElementById('savepdf').onclick=()=>{ if(!chart) return; const {jsPDF}=window.jspdf; const pdf=new jsPDF({orientation:'landscape',unit:'pt',format:'a4'});
    pdf.setFontSize(18); pdf.text('Reporte de Caudales — Proyecto Ñuble',40,40); pdf.setFontSize(12); pdf.text('Gráfico generado desde CSV (fecha vs series).',40,60);
    const img=chart.toBase64Image(); pdf.addImage(img,'PNG',40,80,760,400); pdf.text('Conclusiones:',40,500); pdf.text('- ',60,520); pdf.text('- ',60,540); pdf.text('- ',60,560); pdf.save('reporte_caudales.pdf');
    Logros.set(Logros.keys.PDF);
  };
  </script>
</body></html>
